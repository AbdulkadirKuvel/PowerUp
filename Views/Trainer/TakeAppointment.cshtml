@using PowerUp.Models
@model Trainer

@{
    ViewData["Title"] = "Randevu Al";
    string[] days = { "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar" };

    // Slotları günlere göre grupla
    var slotsByDay = new List<ScheduleSlot>[7];
    for (int i = 0; i < 7; i++) slotsByDay[i] = new List<ScheduleSlot>();

    if (Model.ScheduleSlots != null)
    {
        foreach (var slot in Model.ScheduleSlots)
        {
            slotsByDay[slot.DayOfWeek].Add(slot);
        }
    }

    // Saat aralığını bul
    var allSlots = Model.ScheduleSlots ?? new List<ScheduleSlot>();
    int startHour = allSlots.Any() ? allSlots.Min(s => s.Hour) : 6;
    int endHour = allSlots.Any() ? allSlots.Max(s => s.Hour) : 22;

    // Mantıklı sınırlar belirle
    startHour = Math.Max(0, startHour - 1);
    endHour = Math.Min(23, endHour + 1);
}

<div class="container-fluid mt-5 px-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="text-white"><span class="text-warning">@Model.Name</span> ile Randevu Al</h2>
        </div>
        <div class="col-md-4 text-end">
            <a class="btn btn-outline-light" asp-action="Details" asp-route-id="@Model.Id">
                <i class="fas fa-arrow-left me-2"></i>Geri Dön
            </a>
        </div>
    </div>

    @if (Model.ScheduleSlots == null || Model.ScheduleSlots.Count == 0)
    {
        <div class="alert alert-warning border-0 shadow-sm">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Bu eğitmen henüz hiçbir zaman dilimi eklememiştir. Lütfen daha sonra kontrol ediniz.
        </div>
    }
    else
    {
        <div class="card border-0 shadow-lg mb-4 appointment-card">
            <div class="card-header border-secondary bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Haftalık Takvim</h5>
                <div class="small">
                    <span class="badge bg-success me-2">Boş Slot</span>
                    <span class="badge bg-danger">Dolu / Onaylı</span>
                </div>
            </div>
            <div class="card-body p-0">
                <style>
                    .appointment-grid {
                        display: grid;
                        grid-template-columns: 80px repeat(7, 1fr);
                        gap: 1px;
                        background-color: #444;
                        /* Grid lines color */
                        padding: 1px;
                        border-radius: 4px;
                        overflow-x: auto;
                    }

                    .appointment-cell {
                        background-color: #2c2c2c;
                        /* Cell bg */
                        padding: 6px;
                        min-height: 60px;
                        position: relative;
                        font-size: 12px;
                        color: #ddd;
                    }

                    .appointment-header-day {
                        background-color: #e0a800;
                        /* Warning color darker */
                        color: #000;
                        font-weight: bold;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 12px 6px;
                    }

                    .appointment-header-time {
                        background-color: #212529;
                        color: #aaa;
                        font-weight: bold;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 11px;
                    }

                    .slot-box {
                        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
                        color: white;
                        padding: 8px;
                        border-radius: 4px;
                        margin-bottom: 4px;
                        border-left: 3px solid #75b798;
                        cursor: pointer;
                        transition: all 0.2s;
                        font-size: 11px;
                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                    }

                    .slot-box:hover {
                        transform: translateY(-2px);
                        filter: brightness(1.1);
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
                    }

                    .slot-box.booked {
                        background: linear-gradient(135deg, #dc3545 0%, #a71d2a 100%);
                        border-left-color: #8a131f;
                        cursor: not-allowed;
                        opacity: 0.6;
                    }

                    .slot-box.booked:hover {
                        transform: none;
                        filter: none;
                    }

                    .slot-selected {
                        border: 2px solid white !important;
                        filter: brightness(1.2);
                        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
                    }
                </style>

                <div class="appointment-grid">
                    <div class="appointment-cell appointment-header-time"><i class="far fa-clock"></i></div>
                    @for (int day = 0; day < 7; day++)
                    {
                        <div class="appointment-cell appointment-header-day">@days[day]</div>
                    }

                    @for (int hour = startHour; hour < endHour; hour++)
                    {
                        <div class="appointment-cell appointment-header-time">@hour:00</div>

                        @for (int day = 0; day < 7; day++)
                        {
                            <div class="appointment-cell">
                                @{
                                    var slotsForCell = slotsByDay[day]
                                    .Where(s => s.Hour == hour)
                                    .ToList();
                                }

                                @foreach (var slot in slotsForCell)
                                {
                                    <div class="slot-box" data-slot-id="@slot.Id" data-day="@slot.DayOfWeek" data-hour="@slot.Hour">
                                        <div class="fw-bold">@slot.Gym?.Name</div>
                                        @if (slot.ScheduleSlotServices?.Count > 0)
                                        {
                                            <div class="text-white-50 mt-1 slot-meta">
                                                <i class="fas fa-dumbbell me-1"></i>
                                                @string.Join(", ", slot.ScheduleSlotServices.Take(1).Select(ss => ss.Service?.Name ?? ""))
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <form id="appointmentForm" method="post" asp-action="BookAppointment" asp-controller="Trainer">
            <input type="hidden" name="trainerId" value="@Model.Id">
            <input type="hidden" id="selectedSlotId" name="scheduleSlotId" value="">

            <div class="card border-0 shadow-lg mb-5 appointment-card">
                <div class="card-header bg-warning text-dark fw-bold">
                    <i class="fas fa-calendar-check me-2"></i>Randevu Ayrıntıları
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted">Seçilen Tarih ve Saat</label>
                            <div
                                class="p-3 rounded border border-secondary bg-dark text-warning fw-bold d-flex align-items-center">
                                <i class="far fa-calendar-alt me-2 fs-4"></i>
                                <span id="selectedDateDisplay">-- Önce takvimden bir slot seçiniz --</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="notes" class="form-label text-muted">Notlar (İsteğe Bağlı)</label>
                            <textarea class="form-control bg-dark text-white border-secondary" id="notes" name="notes"
                            rows="2" placeholder="Örn: Özel istekler, sağlık durumu..."></textarea>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-success px-5" id="submitBtn" disabled>
                            <i class="fas fa-check me-2"></i>Randevuyu Tamamla
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <script>
            const appointmentDate = document.getElementById('appointmentDate');
            const submitBtn = document.getElementById('submitBtn');
            const form = document.getElementById('appointmentForm');
            const trainerId = document.querySelector('input[name="trainerId"]').value;
            const selectedSlotInput = document.getElementById('selectedSlotId');
            const slotBoxes = document.querySelectorAll('.slot-box');
            let currentUserTrainerId = null;

            // ... (Buradaki Javascript mantığı aynı kalacak, sadece stil sınıfları güncellendi) ...

            // Mevcut randevuları yükle
            async function loadBookedAppointments() {
                try {
                    const response = await fetch(`/api/trainer/${trainerId}/booked-appointments`);
                    if (response.ok) {
                        const bookedAppointments = await response.json();
                        slotBoxes.forEach(box => {
                            const slotId = parseInt(box.dataset.slotId);
                            const isBooked = bookedAppointments.some(app => app.scheduleSlotId === slotId);
                            if (isBooked) {
                                box.classList.add('booked');
                                box.style.pointerEvents = 'none';
                                box.innerHTML += '<div class="mt-1 badge bg-dark"><i class="fas fa-lock"></i> Dolu</div>';
                            }
                        });
                    }
                } catch (error) { console.error(error); }
            }

            // Slot seçimi
            slotBoxes.forEach(box => {
                box.addEventListener('click', function () {
                    if (this.classList.contains('booked')) return;

                    // Görsel seçim efekti
                    document.querySelectorAll('.slot-box').forEach(b => b.classList.remove('slot-selected'));
                    this.classList.add('slot-selected');

                    submitBtn.disabled = true;
                    selectedSlotInput.value = '';

                    const dayOfWeek = parseInt(this.dataset.day);
                    const hour = parseInt(this.dataset.hour);
                    const slotId = parseInt(this.dataset.slotId);

                    selectedSlotInput.value = slotId;

                    // Tarih hesaplama
                    const today = new Date();
                    let selectedDate = null;

                    for (let i = 0; i < 7; i++) {
                        const date = new Date(today);
                        date.setDate(date.getDate() + i);
                        let jsDayOfWeek = date.getDay();
                        let csharpDayOfWeek = jsDayOfWeek === 0 ? 6 : jsDayOfWeek - 1;
                        if (csharpDayOfWeek === dayOfWeek) {
                            selectedDate = date;
                            break;
                        }
                    }

                    if (selectedDate) {
                        const dayName = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'][selectedDate.getDay()];
                        const displayDate = new Date(selectedDate).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });

                        // Eski hidden inputu temizle
                        const oldInput = form.querySelector('input[name="appointmentDate"]');
                        if (oldInput) oldInput.remove();

                        // Yeni tarihi input olarak ekle
                        const dateStr = selectedDate.toISOString().split('T')[0];
                        const appointmentDateInput = document.createElement('input');
                        appointmentDateInput.type = 'hidden';
                        appointmentDateInput.name = 'appointmentDate';
                        appointmentDateInput.value = dateStr;
                        form.appendChild(appointmentDateInput);

                        document.getElementById('selectedDateDisplay').innerHTML = `${displayDate} (${dayName}) <span class="ms-3 badge bg-light text-dark fs-6">${hour}:00</span>`;
                        submitBtn.disabled = false;
                    }
                });
            });

            // ... (Form submit ve diğer JS kısımları aynı) ...
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                if (!selectedSlotInput.value) {
                    window.DialogBox.show({
                        type: 'error',
                        title: 'Hata',
                        message: 'Lütfen takvimden bir zaman dilimi seçiniz!'
                    });
                    return;
                }

                const formData = new FormData(form);
                formData.set('trainerId', trainerId);

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // Show success dialog
                        window.DialogBox.show({
                            type: 'informant',
                            title: 'Başarılı',
                            message: 'Randevu başarıyla oluşturuldu! Eğitmen tarafından onay beklenektedir.',
                            buttons: [
                                {
                                    text: 'Tamam',
                                    action: () => {
                                        window.location.href = '@Url.Action("Details", "Trainer", new { id = "TRAINER_ID" })'.replace('TRAINER_ID', trainerId);
                                    },
                                    isPrimary: true
                                }
                            ]
                        });
                    } else {
                        const error = await response.json();
                        window.DialogBox.show({
                            type: 'error',
                            title: 'Hata',
                            message: error.message || 'Randevu oluşturulamadı!'
                        });
                    }
                } catch (error) {
                    window.DialogBox.show({
                        type: 'error',
                        title: 'Hata',
                        message: 'Bir hata oluştu: ' + error.message
                    });
                }
            });

            // Load booked appointments on page load
            document.addEventListener('DOMContentLoaded', function () {
                loadCurrentUserTrainerId();
                loadBookedAppointments();
            });

            document.addEventListener('DOMContentLoaded', function () {
                loadBookedAppointments();
            });
        </script>
    }
</div>