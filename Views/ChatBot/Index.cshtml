@{
    ViewData["Title"] = "AI Asistan";
}

<style>
    /* PowerUp Chat Tema Ã–zel CSS */
    .chat-card {
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        height: 80vh; /* EkranÄ±n %80'ini kaplasÄ±n */
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
    }

    .chat-body {
        flex: 1;
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 1.5rem;
        scroll-behavior: smooth;
    }

    /* Scrollbar Ã–zelleÅŸtirme */
    .chat-body::-webkit-scrollbar {
        width: 6px;
    }
    .chat-body::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    .chat-body::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
    }

    .message {
        margin-bottom: 1.5rem;
        animation: fadeIn 0.3s ease;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message-content {
        padding: 1rem 1.2rem;
        position: relative;
        max-width: 80%;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    /* Bot Mesaj Balonu */
    .bot-message {
        background-color: white;
        border-radius: 0 20px 20px 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border: 1px solid #eef0f2;
        color: #4a4a4a;
    }

    /* KullanÄ±cÄ± Mesaj Balonu */
    .user-message {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px 0 20px 20px;
        color: white;
        box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
    }

    .chat-footer {
        background-color: white;
        border-top: 1px solid #eee;
        padding: 1rem;
    }

    .quick-action-btn {
        font-size: 0.8rem;
        transition: all 0.2s;
    }
    .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Dosya YÃ¼kleme AlanÄ± */
    .file-preview-badge {
        display: none;
        font-size: 0.8rem;
        background-color: #e9ecef;
        padding: 5px 10px;
        border-radius: 15px;
        margin-bottom: 10px;
        color: #495057;
    }
    
    .loading-dots:after {
        content: ' .';
        animation: dots 1s steps(5, end) infinite;
    }

    #messageInput {
        color: #333;
    }
    
    @@keyframes dots {
        0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
        40% { color: #333; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
        60% { text-shadow: .25em 0 0 #333, .5em 0 0 rgba(0,0,0,0);}
        80%, 100% { text-shadow: .25em 0 0 #333, .5em 0 0 #333;}
    }
</style>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">
            
            <div class="card chat-card">
                
                <div class="chat-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                            <i class="fas fa-brain fa-lg text-white"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 fw-bold">PowerUp AI</h5>
                            <small class="text-white-50">Gemini & Pollinations Destekli</small>
                        </div>
                    </div>
                    <div>
                        <span class="badge bg-white text-primary rounded-pill px-3 py-2">
                            <i class="fas fa-circle fa-xs me-1 text-success"></i> Online
                        </span>
                    </div>
                </div>

                <div class="chat-body" id="chatContainer">
                    <div class="message d-flex justify-content-start">
                        <div class="d-flex flex-column align-items-start" style="max-width: 80%;">
                            <div class="message-content bot-message">
                                <p class="mb-0">
                                    <i class="fas fa-robot text-primary me-2"></i>
                                    Merhaba! Ben PowerUp AsistanÄ±. 
                                    <br><br>
                                    ðŸ’ª Spor tavsiyeleri verebilirim.
                                    <br>
                                    ðŸ“¸ Resminizi analiz edip, 3 ay sonraki halinizi Ã§izebilirim.
                                    <br>
                                    ðŸ“… Randevu almanÄ±za yardÄ±mcÄ± olabilirim.
                                </p>
                            </div>
                            <small class="text-muted ms-2 mt-1" style="font-size: 0.7rem;">Åžimdi</small>
                        </div>
                    </div>
                </div>

                <div class="chat-footer">
                    <div id="filePreview" class="file-preview-badge align-items-center">
                        <i class="fas fa-image me-2 text-primary"></i>
                        <span id="fileName">resim.jpg</span>
                        <button type="button" class="btn-close ms-2" style="font-size: 0.7rem;" onclick="clearFile()"></button>
                    </div>

                    <form id="chatForm" class="d-flex align-items-center gap-2" enctype="multipart/form-data">
                        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect()">
                        
                        <button type="button" class="btn btn-light rounded-circle text-muted border" 
                                style="width: 45px; height: 45px;" 
                                onclick="document.getElementById('fileInput').click()"
                                title="Resim YÃ¼kle">
                            <i class="fas fa-paperclip"></i>
                        </button>

                        <input type="text" class="form-control border-0 bg-light rounded-pill px-4 py-2" 
                               id="messageInput" 
                               placeholder="MesajÄ±nÄ±zÄ± yazÄ±n veya resim yÃ¼kleyin..." 
                               style="height: 45px;" autocomplete="off">

                        <button class="btn btn-primary rounded-circle shadow-sm" 
                                type="submit" 
                                style="width: 45px; height: 45px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border:none;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    
                    <div class="mt-4 d-flex gap-2 overflow-auto pb-1" style="scrollbar-width: none;">
                        <button class="btn btn-outline-secondary rounded-pill btn-sm quick-action-btn text-nowrap" onclick="sendQuickMessage('3 ay spor yaparsam nasÄ±l gÃ¶rÃ¼nÃ¼rÃ¼m? (Resim YÃ¼kle)')">
                            <i class="fas fa-camera me-1"></i>Gelecekteki Ben
                        </button>
                        <button class="btn btn-outline-secondary rounded-pill btn-sm quick-action-btn text-nowrap" onclick="sendQuickMessage('Kilo vermek iÃ§in ne yemeliyim?')">
                            <i class="fas fa-apple-alt me-1"></i>Beslenme Tavsiyesi
                        </button>
                        <button class="btn btn-outline-secondary rounded-pill btn-sm quick-action-btn text-nowrap" onclick="sendQuickMessage('Randevu almak istiyorum')">
                            <i class="fas fa-calendar-check me-1"></i>Randevu
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const fileNameDisplay = document.getElementById('fileName');
    const chatForm = document.getElementById('chatForm');

    // Dosya seÃ§ildiÄŸinde Ã§alÄ±ÅŸÄ±r
    function handleFileSelect() {
        if (fileInput.files.length > 0) {
            filePreview.style.display = 'inline-flex';
            fileNameDisplay.textContent = fileInput.files[0].name;
            messageInput.placeholder = "Resim ile ilgili sorunuzu yazÄ±n...";
            messageInput.focus();
        }
    }

    // Dosya seÃ§imini iptal eder
    function clearFile() {
        fileInput.value = '';
        filePreview.style.display = 'none';
        messageInput.placeholder = "MesajÄ±nÄ±zÄ± yazÄ±n...";
    }

    // HÄ±zlÄ± mesaj gÃ¶nderme
    function sendQuickMessage(msg) {
        if(msg.includes("Resim YÃ¼kle")) {
            // KullanÄ±cÄ±yÄ± resim yÃ¼klemeye teÅŸvik et
            document.getElementById('fileInput').click();
            messageInput.value = "Bu fotoÄŸrafÄ±ma gÃ¶re 3 ay spor yaparsam nasÄ±l gÃ¶rÃ¼nÃ¼rÃ¼m?";
        } else {
            messageInput.value = msg;
            handleFormSubmit(new Event('submit'));
        }
    }

    // MesajÄ± Ekrana Ekleme (HTML String OluÅŸturucu)
    function appendMessage(content, isUser, imageUrl = null) {
        const div = document.createElement('div');
        div.className = `message d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'}`;
        
        const bubbleClass = isUser ? 'user-message' : 'bot-message';
        const iconHtml = isUser ? '' : '<i class="fas fa-robot text-primary me-2"></i>';
        
        let imageHtml = '';
        if (imageUrl) {
            imageHtml = `
                <div class="mt-3">
                    <img src="${imageUrl}" class="img-fluid rounded shadow-sm border" style="max-height: 300px;" alt="Generated Image">
                    <div class="mt-1"><small class="text-muted"><i class="fas fa-magic me-1"></i>AI tarafÄ±ndan oluÅŸturuldu</small></div>
                </div>
            `;
        }

        // EÄŸer kullanÄ±cÄ± resim yÃ¼klediyse ve mesaj gÃ¶nderdiyse (istemci tarafÄ±nda basit gÃ¶sterim)
        let uploadedImageHtml = '';
        if (isUser && fileInput.files.length > 0 && content === messageInput.value) {
             // KullanÄ±cÄ±nÄ±n yÃ¼klediÄŸi resmi Ã¶nizleme olarak sohbete ekleyebiliriz (opsiyonel, ÅŸu an karmaÅŸÄ±klÄ±k olmasÄ±n diye eklemiyorum)
             // Ancak "Resim Eklendi" ibaresi koyalÄ±m
             uploadedImageHtml = '<div class="text-white-50 mb-1"><small><i class="fas fa-paperclip"></i> Resim Eklendi</small></div>';
        }

        div.innerHTML = `
            <div class="d-flex flex-column ${isUser ? 'align-items-end' : 'align-items-start'}" style="max-width: 80%;">
                <div class="message-content ${bubbleClass}">
                    ${uploadedImageHtml}
                    <p class="mb-0">
                        ${iconHtml}
                        ${content.replace(/\n/g, '<br>')}
                    </p>
                    ${imageHtml}
                </div>
                <small class="text-muted ${isUser ? 'me-2' : 'ms-2'} mt-1" style="font-size: 0.7rem;">Az Ã¶nce</small>
            </div>
        `;

        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Form Submit Ä°ÅŸlemi
    async function handleFormSubmit(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        const hasFile = fileInput.files.length > 0;

        if (!message && !hasFile) return;

        // 1. KullanÄ±cÄ± mesajÄ±nÄ± ekrana bas
        appendMessage(message || (hasFile ? "Resim analizi istiyorum." : ""), true);

        // 2. Form Data HazÄ±rla
        const formData = new FormData();
        formData.append("message", message);
        if (hasFile) {
            formData.append("file", fileInput.files[0]);
        }

        // InputlarÄ± temizle
        messageInput.value = '';
        const tempHasFile = hasFile; // clearFile yapmadan Ã¶nce durumu sakla
        clearFile();

        // 3. YÃ¼kleniyor GÃ¶stergesi
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message d-flex justify-content-start';
        loadingDiv.id = 'loadingIndicator';
        loadingDiv.innerHTML = `
            <div class="message-content bot-message text-muted fst-italic">
                <i class="fas fa-robot text-primary me-2"></i>
                <span class="loading-dots">DÃ¼ÅŸÃ¼nÃ¼yor</span>
            </div>
        `;
        chatContainer.appendChild(loadingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
            // 4. API Ä°steÄŸi
            const response = await fetch('@Url.Action("SendMessage", "ChatBot")', {
                method: 'POST',
                body: formData // Content-Type: multipart/form-data otomatik ayarlanÄ±r
            });

            const data = await response.json();

            // YÃ¼kleniyor'u kaldÄ±r
            loadingDiv.remove();

            if (data.success) {
                appendMessage(data.message, false, data.imageUrl);
            } else {
                appendMessage("ÃœzgÃ¼nÃ¼m, bir hata oluÅŸtu: " + data.message, false);
            }

        } catch (error) {
            loadingDiv.remove();
            console.error(error);
            appendMessage("BaÄŸlantÄ± hatasÄ± oluÅŸtu.", false);
        }
    }

    chatForm.addEventListener('submit', handleFormSubmit);
</script>